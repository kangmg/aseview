!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).ASEView={})}(this,function(e){"use strict";class o{constructor(e,o={}){if(this.container="string"==typeof e?document.querySelector(e):e,!this.container)throw new Error("Container element not found");this.options={backgroundColor:o.backgroundColor||"#1f2937",antialias:!1!==o.antialias,...o},this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.directionalLight=null,this.moleculeGroup=null,this.axisScene=null,this.axisCamera=null,this._init()}_init(){this.renderer=new THREE.WebGLRenderer({antialias:this.options.antialias,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.outputEncoding=THREE.sRGBEncoding,this.renderer.toneMapping=THREE.ACESFilmicToneMapping,this.renderer.toneMappingExposure=1,this.container.appendChild(this.renderer.domElement),this.scene=new THREE.Scene,this._updateBackgroundColor(),this._setupCamera(),this._setupControls(),this._setupLighting(),this._setupAxisHelper(),window.addEventListener("resize",()=>this._handleResize())}_setupCamera(){const e=(this.container.clientWidth||1)/(this.container.clientHeight||1);if("Orthographic"===this.options.viewMode){const o=20;this.camera=new THREE.OrthographicCamera(o*e/-2,o*e/2,o/2,o/-2,-1e3,1e3)}else this.camera=new THREE.PerspectiveCamera(55,e,.1,2e3);this.camera.position.set(0,0,10)}_setupControls(){this.controls&&this.controls.dispose(),"Orbit"===this.options.rotationMode&&THREE.OrbitControls?this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement):THREE.TrackballControls&&(this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8),this.controls&&this.controls.update()}_setupLighting(){this.directionalLight=new THREE.DirectionalLight(16777215,.8),this.directionalLight.position.set(10,10,10),this.scene.add(this.directionalLight);const e=new THREE.AmbientLight(16777215,.2);this.scene.add(e)}_setupAxisHelper(){this.axisScene=new THREE.Scene;const e=100;this.axisCamera=new THREE.OrthographicCamera(-100,e,e,-100,-100,100),this.axisCamera.position.set(0,0,50);const o=16729156,r=4508740,t=4491519,i=40,s=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1),c=new THREE.Vector3(0,0,0),l=new THREE.ArrowHelper(s,c,i,o,12,6),d=new THREE.ArrowHelper(n,c,i,r,12,6),h=new THREE.ArrowHelper(a,c,i,t,12,6);this.axisScene.add(l),this.axisScene.add(d),this.axisScene.add(h);const u=(e,o)=>{const r=document.createElement("canvas");r.width=64,r.height=64;const t=r.getContext("2d");t.font="bold 48px Arial",t.textAlign="center",t.textBaseline="middle",t.fillStyle="#"+o.toString(16).padStart(6,"0"),t.fillText(e,32,32);const i=new THREE.CanvasTexture(r),s=new THREE.SpriteMaterial({map:i,transparent:!0}),n=new THREE.Sprite(s);return n.scale.set(16,16,1),n},E=u("X",o),p=u("Y",r),m=u("Z",t);E.position.set(52,0,0),p.position.set(0,52,0),m.position.set(0,0,52),this.axisScene.add(E),this.axisScene.add(p),this.axisScene.add(m);const T=new THREE.AmbientLight(16777215,1);this.axisScene.add(T)}_updateBackgroundColor(){const e=new THREE.Color(this.options.backgroundColor);this.scene.background=e,this.renderer.setClearColor(e,1)}_handleResize(){const e=this.container.clientWidth||1,o=this.container.clientHeight||1;if(this.renderer.setSize(e,o),this.camera.isPerspectiveCamera)this.camera.aspect=e/o;else{const r=20,t=e/o;this.camera.left=r*t/-2,this.camera.right=r*t/2,this.camera.top=r/2,this.camera.bottom=r/-2}this.camera.updateProjectionMatrix(),this.controls&&"function"==typeof this.controls.handleResize&&this.controls.handleResize()}render(){if(this.controls&&this.controls.update(),this.directionalLight&&this.camera){const e=new THREE.Vector3(5,8,5),o=this.camera.position.clone().add(e.applyQuaternion(this.camera.quaternion));this.directionalLight.position.copy(o)}if(this.renderer.render(this.scene,this.camera),this.axisScene&&this.axisCamera){this.axisCamera.quaternion.copy(this.camera.quaternion);const e=this.renderer.getViewport(new THREE.Vector4),o=100;this.renderer.setViewport(10,10,o,o),this.renderer.setScissor(10,10,o,o),this.renderer.setScissorTest(!0),this.renderer.clearDepth(),this.renderer.render(this.axisScene,this.axisCamera),this.renderer.setScissorTest(!1),this.renderer.setViewport(e)}}animate(){const e=()=>{requestAnimationFrame(e),this.render()};e()}fitToMolecule(e){const o=(new THREE.Box3).setFromObject(e);if(!isFinite(o.max.x))return;const r=o.getCenter(new THREE.Vector3),t=o.getSize(new THREE.Vector3),i=Math.max(t.x,t.y,t.z,1);if(this.camera.isPerspectiveCamera){const e=THREE.MathUtils.degToRad(this.camera.fov/2),o=i/(2*Math.tan(e))+i;this.camera.position.copy(r.clone().add(new THREE.Vector3(o,o,o)))}else{const e=this.container.clientWidth/this.container.clientHeight;this.camera.left=-i*e,this.camera.right=i*e,this.camera.top=i,this.camera.bottom=-i}this.controls&&(this.controls.target.copy(r),this.controls.update()),this.camera.lookAt(r),this.camera.updateProjectionMatrix()}dispose(){this.controls&&this.controls.dispose(),this.renderer&&(this.renderer.dispose(),this.container.removeChild(this.renderer.domElement))}}const r={H:{color:16777215,radius:.31},He:{color:14286847,radius:.28},Li:{color:13402367,radius:1.28},Be:{color:12779264,radius:.96},B:{color:16758197,radius:.84},C:{color:9474192,radius:.76},N:{color:3166456,radius:.71},O:{color:16715021,radius:.66},F:{color:9494608,radius:.57},Ne:{color:11789301,radius:.58},Na:{color:11230450,radius:1.66},Mg:{color:9109248,radius:1.41},Al:{color:12560038,radius:1.21},Si:{color:1578e4,radius:1.11},P:{color:16744448,radius:1.07},S:{color:16777008,radius:1.05},Cl:{color:2093087,radius:1.02},Ar:{color:8442339,radius:1.06},K:{color:9388244,radius:2.03},Ca:{color:4062976,radius:1.76},Sc:{color:15132390,radius:1.7},Ti:{color:12567239,radius:1.6},V:{color:10921643,radius:1.53},Cr:{color:9083335,radius:1.39},Mn:{color:10255047,radius:1.39},Fe:{color:14706227,radius:1.32},Co:{color:15765664,radius:1.26},Ni:{color:5296208,radius:1.24},Cu:{color:13140019,radius:1.32},Zn:{color:8224944,radius:1.22},Ga:{color:12750735,radius:1.22},Ge:{color:6721423,radius:1.2},As:{color:12419299,radius:1.19},Se:{color:16752896,radius:1.2},Br:{color:10889513,radius:1.2},Kr:{color:6076625,radius:1.16},Rb:{color:7351984,radius:2.2},Sr:{color:65280,radius:1.95},Y:{color:9764863,radius:1.9},Zr:{color:9756896,radius:1.75},Nb:{color:7586505,radius:1.64},Mo:{color:5551541,radius:1.54},Tc:{color:3907230,radius:1.47},Ru:{color:2396047,radius:1.46},Rh:{color:687500,radius:1.42},Pd:{color:27013,radius:1.39},Ag:{color:12632256,radius:1.45},Cd:{color:16767375,radius:1.44},In:{color:10909043,radius:1.42},Sn:{color:6717568,radius:1.39},Sb:{color:10380213,radius:1.39},Te:{color:13924864,radius:1.38},I:{color:9699476,radius:1.39},Xe:{color:4366e3,radius:1.4},Cs:{color:5707663,radius:2.44},Ba:{color:51456,radius:2.15},La:{color:7394559,radius:2.07},Ce:{color:16777159,radius:2.04},Pt:{color:13684960,radius:1.36},Au:{color:16765219,radius:1.36},Hg:{color:12105936,radius:1.32},Tl:{color:10900557,radius:1.45},Pb:{color:5724513,radius:1.46},Bi:{color:10375093,radius:1.48},Po:{color:11230208,radius:1.4},At:{color:7688005,radius:1.5},Rn:{color:4358806,radius:1.5},Fr:{color:4325478,radius:2.6},Ra:{color:32e3,radius:2.21},Ac:{color:7384058,radius:2.15},Th:{color:47871,radius:2.06},Pa:{color:41471,radius:2},U:{color:36863,radius:1.96},default:{color:16716947,radius:1.5}};function t(e){return r[e]||r.default}function i(e,o,r=1.2){const i=[],s=e.length;for(let n=0;n<s;n++)for(let a=n+1;a<s;a++){const s=t(o[n]),c=t(o[a]),l=e[n][0]-e[a][0],d=e[n][1]-e[a][1],h=e[n][2]-e[a][2];Math.sqrt(l*l+d*d+h*h)<=(s.radius+c.radius)*r&&i.push([n,a])}return i}function s(e,o,r=1,i="cartoon",s={}){const n=t(o),a=n.radius*r,c=void 0!==s.color?s.color:n.color,l=Array.isArray(e)?new THREE.Vector3(e[0],e[1],e[2]):e;switch(i){case"cartoon":return function(e,o,r){const t=new THREE.SphereGeometry(o,32,32),i=new THREE.MeshToonMaterial({color:r}),s=new THREE.Mesh(t,i);return s.position.copy(e),s}(l,a,c);case"glossy":return function(e,o,r){const t=new THREE.SphereGeometry(o,32,32),i=new THREE.MeshPhongMaterial({color:r,shininess:100,specular:4473924}),s=new THREE.Mesh(t,i);return s.position.copy(e),s}(l,a,c);case"metallic":return function(e,o,r){const t=new THREE.SphereGeometry(o,32,32),i=new THREE.MeshStandardMaterial({color:r,metalness:.8,roughness:.2}),s=new THREE.Mesh(t,i);return s.position.copy(e),s}(l,a,c);case"neon":return function(e,o,r){const t=new THREE.Group,i=new THREE.SphereGeometry(.8*o,32,32),s=new THREE.MeshBasicMaterial({color:r}),n=new THREE.Mesh(i,s);t.add(n);const a=new THREE.SphereGeometry(o,32,32),c=new THREE.MeshBasicMaterial({color:r,transparent:!0,opacity:.3}),l=new THREE.Mesh(a,c);return t.add(l),t.position.copy(e),t}(l,a,c);case"bubble":return function(e,o,r){const t=new THREE.SphereGeometry(o,32,32),i=new THREE.MeshPhongMaterial({color:r,transparent:!0,opacity:.6,shininess:100,specular:16777215}),s=new THREE.Mesh(t,i);return s.position.copy(e),s}(l,a,c);case"2d":return function(e,o,r){const t=new THREE.Group,i=new THREE.CircleGeometry(o,32),s=new THREE.MeshBasicMaterial({color:r,side:THREE.DoubleSide}),n=new THREE.Mesh(i,s);t.add(n);const a=new THREE.RingGeometry(.9*o,o,32),c=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide}),l=new THREE.Mesh(a,c);return l.position.z=.01,t.add(l),t.position.copy(e),t}(l,a,c);default:return function(e,o,r){const t=new THREE.SphereGeometry(o,32,32),i=new THREE.MeshPhongMaterial({color:r,shininess:30}),s=new THREE.Mesh(t,i);return s.position.copy(e),s}(l,a,c)}}function n(e,o=-1,r=1){const t=r-o,i=t>0?(e-o)/t:.5,s=new THREE.Color(3886272),n=new THREE.Color(16250871),a=new THREE.Color(11797542),c=new THREE.Color;return i<.5?c.lerpColors(s,n,2*i):c.lerpColors(n,a,2*(i-.5)),c.getHex()}function a(e,o,r,i,s=.1,n="cartoon",a={}){const c=Array.isArray(e)?new THREE.Vector3(e[0],e[1],e[2]):e,l=Array.isArray(o)?new THREE.Vector3(o[0],o[1],o[2]):o;switch(n){case"cartoon":return function(e,o,r,t,i){const s=new THREE.Group,n=(new THREE.Vector3).addVectors(e,o).multiplyScalar(.5),a=(new THREE.Vector3).subVectors(o,e),c=a.length()/2,l=3355443,d=new THREE.CylinderGeometry(i,i,c,16),h=new THREE.MeshToonMaterial({color:l}),u=new THREE.Mesh(d,h),E=(new THREE.Vector3).addVectors(e,n).multiplyScalar(.5);u.position.copy(E),u.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),a.clone().normalize()),s.add(u);const p=new THREE.CylinderGeometry(i,i,c,16),m=new THREE.MeshToonMaterial({color:l}),T=new THREE.Mesh(p,m),w=(new THREE.Vector3).addVectors(n,o).multiplyScalar(.5);return T.position.copy(w),T.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),a.clone().normalize()),s.add(T),s}(c,l,0,0,s);case"neon":return function(e,o,r,i){const s=new THREE.Group,n=(new THREE.Vector3).addVectors(e,o).multiplyScalar(.5),a=(new THREE.Vector3).subVectors(o,e);a.length();const c=t(r).color,l=t(i).color,d=[e,n],h=(new THREE.BufferGeometry).setFromPoints(d),u=new THREE.LineBasicMaterial({color:c,linewidth:2}),E=new THREE.Line(h,u);s.add(E);const p=[n,o],m=(new THREE.BufferGeometry).setFromPoints(p),T=new THREE.LineBasicMaterial({color:l,linewidth:2}),w=new THREE.Line(m,T);return s.add(w),s}(c,l,r,i);case"2d":return function(e,o){const r=[e,o],t=(new THREE.BufferGeometry).setFromPoints(r),i=new THREE.LineBasicMaterial({color:0,linewidth:2});return new THREE.Line(t,i)}(c,l);default:return function(e,o,r,i,s){const n=new THREE.Group,a=(new THREE.Vector3).addVectors(e,o).multiplyScalar(.5),c=(new THREE.Vector3).subVectors(o,e),l=c.length()/2,d=t(r).color,h=t(i).color,u=new THREE.CylinderGeometry(s,s,l,16),E=new THREE.MeshPhongMaterial({color:d}),p=new THREE.Mesh(u,E),m=(new THREE.Vector3).addVectors(e,a).multiplyScalar(.5);p.position.copy(m),p.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),c.clone().normalize()),n.add(p);const T=new THREE.CylinderGeometry(s,s,l,16),w=new THREE.MeshPhongMaterial({color:h}),R=new THREE.Mesh(T,w),H=(new THREE.Vector3).addVectors(a,o).multiplyScalar(.5);return R.position.copy(H),R.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),c.clone().normalize()),n.add(R),n}(c,l,r,i,s)}}e.MolecularViewer=class{constructor(e,r={}){this.options={style:"cartoon",backgroundColor:"#1f2937",showBond:!0,showCell:!1,atomSize:1,bondThickness:.15,bondThreshold:1.2,colorBy:"Element",...r},this.sceneManager=new o(e,{backgroundColor:this.options.backgroundColor,viewMode:this.options.viewMode,rotationMode:this.options.rotationMode}),this.moleculeGroup=null,this.molecularData=null,this.sceneManager.animate()}setData(e){this.molecularData=e,this._render()}setOptions(e){Object.assign(this.options,e),this.molecularData&&this._render()}_render(){if(!this.molecularData)return;this.moleculeGroup&&(this.sceneManager.scene.remove(this.moleculeGroup),this._disposeGroup(this.moleculeGroup)),this.moleculeGroup=new THREE.Group;const{symbols:e,positions:o,charges:r,cell:t}=this.molecularData,c=o.length;let l=0,d=0;if(r&&"Charge"===this.options.colorBy){l=Math.min(...r),d=Math.max(...r);const e=Math.max(Math.abs(l),Math.abs(d));l=-e,d=e}(this.options.showBond?i(o,e,this.options.bondThreshold):[]).forEach(([r,t])=>{const i=a(o[r],o[t],e[r],e[t],this.options.bondThickness,this.options.style);i&&this.moleculeGroup.add(i)});for(let t=0;t<c;t++){let i;"Charge"===this.options.colorBy&&r&&(i=n(r[t],l,d));const a=s(o[t],e[t],this.options.atomSize,this.options.style,{color:i});a&&this.moleculeGroup.add(a)}this.options.showCell&&t&&this._renderCell(t),this.sceneManager.scene.add(this.moleculeGroup),this.sceneManager.fitToMolecule(this.moleculeGroup)}_renderCell(e){const o=new THREE.Vector3(0,0,0),r=new THREE.Vector3(...e[0]),t=new THREE.Vector3(...e[1]),i=new THREE.Vector3(...e[2]),s=[o,r,o,t,o,i,r,r.clone().add(t),r,r.clone().add(i),t,t.clone().add(r),t,t.clone().add(i),i,i.clone().add(r),i,i.clone().add(t),r.clone().add(t),r.clone().add(t).add(i),r.clone().add(i),r.clone().add(t).add(i),t.clone().add(i),r.clone().add(t).add(i)],n=(new THREE.BufferGeometry).setFromPoints(s),a=new THREE.LineBasicMaterial({color:16711680}),c=new THREE.LineSegments(n,a);this.moleculeGroup.add(c)}_disposeGroup(e){e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())})}screenshot(){return this.sceneManager.render(),this.sceneManager.renderer.domElement.toDataURL("image/png")}dispose(){this.moleculeGroup&&(this.sceneManager.scene.remove(this.moleculeGroup),this._disposeGroup(this.moleculeGroup)),this.sceneManager.dispose()}},e.SceneManager=o,e.atomInfo=r,e.createAtom=s,e.createBond=a,e.detectBonds=i,e.getAtomInfo=t,e.getChargeColor=n,e.version="0.1.0"});
